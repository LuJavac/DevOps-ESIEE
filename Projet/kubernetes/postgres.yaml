# PostgreSQL Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  labels:
    app: postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:15-alpine
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          value: "equipements"
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_PASSWORD
          value: "devops2026"
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        - name: init-script
          mountPath: /docker-entrypoint-initdb.d
      volumes:
      - name: postgres-storage
        emptyDir: {}
      - name: init-script
        configMap:
          name: postgres-init-script

---
# PostgreSQL Service
apiVersion: v1
kind: Service
metadata:
  name: postgres-service
  labels:
    app: postgres
spec:
  type: ClusterIP
  ports:
  - port: 5432
    targetPort: 5432
    protocol: TCP
  selector:
    app: postgres

---
# ConfigMap avec le script d'initialisation
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-script
data:
  init.sql: |
    -- Script d'initialisation de la base de données equipements
    
    -- Suppression de la table si elle existe déjà
    DROP TABLE IF EXISTS equipements CASCADE;
    
    -- Création de la table equipements
    CREATE TABLE equipements (
        id SERIAL PRIMARY KEY,
        equip_nom VARCHAR(255) NOT NULL,
        commune_nom VARCHAR(255) NOT NULL,
        equip_type VARCHAR(100),
        latitude DECIMAL(10, 8),
        longitude DECIMAL(11, 8),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- Index pour améliorer les performances
    CREATE INDEX idx_commune ON equipements(commune_nom);
    CREATE INDEX idx_type ON equipements(equip_type);
    
    -- Données de test
    INSERT INTO equipements (equip_nom, commune_nom, equip_type, latitude, longitude) VALUES
    ('Stade Municipal', 'Paris', 'Stade', 48.8566, 2.3522),
    ('Piscine Olympique', 'Lyon', 'Piscine', 45.7640, 4.8357),
    ('Court de Tennis', 'Marseille', 'Tennis', 43.2965, 5.3698),
    ('Gymnase des Sports', 'Toulouse', 'Gymnase', 43.6047, 1.4442),
    ('Terrain de Football', 'Nice', 'Football', 43.7102, 7.2620);
    
    -- Message de confirmation
    DO $$
    BEGIN
        RAISE NOTICE 'Base de données initialisée avec succès !';
    END $$;
